---
name: Simple workflow

on:
  push:
    branches:
      - main
      # TODO update this
      - setup-workflows
  # pull_request:
  #   types:
  #     - opened
  #     - synchronize
  #     - reopened
  #     - ready_for_review
  #   branches:
  #     - main

# Prerequisites to run workflows:
# Actions -> I understand my workflows...
# Settings -> Actions -> General -> Workflow permissions -> Read and write permissions

env:
  ENABLED_STEPS: |
    checkout_repository
    setup_r
    setup_dependencies
    get_package_name
    build_r_package
    run_r_cmd_check
    upload_artifact

# When asked to, please add the steps from the list above:
# env:
#   ENABLED_STEPS: |
#     checkout_...
#     setup_...
#     setup_...
#     get_package_...
#     build_r_...
#     run_r_...
#     upload_...

jobs:
  hello-world-from-r:
    name: Hello, world!
    runs-on: ubuntu-latest
    steps:
      - name: Setup R üîß
        uses: r-lib/actions/setup-r@v2

      - name: Hello world! üí¨
        run: cat(paste0("Hello ", Sys.getenv("NAME"), "! üëã"))
        shell: Rscript {0}
        env:
          NAME: "Your name"

  build-and-check:
    name: Build R package
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo üõé
        # We're using an official GitHub Action.
        uses: actions/checkout@v4.1.1
        if: contains(env.ENABLED_STEPS, 'checkout_repository')
        with:
          # Action inputs (arguments/parameters).
          # In this case we clone the repository to the directory called the same
          # as the repository name.
          path: ${{ github.event.repository.name }}

      - name: Setup R üîß
        if: contains(env.ENABLED_STEPS, 'setup_r')
        uses: r-lib/actions/setup-r@v2

      - name: Setup R dependencies üîß
        uses: r-lib/actions/setup-r-dependencies@v2
        if: contains(env.ENABLED_STEPS, 'setup_dependencies')
        with:
          extra-packages: any::rcmdcheck
          working-directory: ${{ github.event.repository.name }}

      # Get package name and version from DESCRIPTION so that we'll know
      # what's the name of the tar.gz file with the built package.
      - name: Get package name üì¶
        if: contains(env.ENABLED_STEPS, 'get_package_name')
        run: |
          PKGBUILD="$(Rscript -e 'cat(sprintf("%s_%s.tar.gz",(dcf <- read.dcf("DESCRIPTION"))[,"Package"], dcf[,"Version"]))')"
          echo "PKGBUILD = $PKGBUILD"
          echo "PKGBUILD=$PKGBUILD" >> $GITHUB_ENV
        shell: bash
        working-directory: ${{ github.event.repository.name }}

      # Build a package stored in a directory called ${{ github.event.repository.name }}
      - name: Build R package üèó
        if: contains(env.ENABLED_STEPS, 'build_r_package')
        run: |
          R CMD build ${{ github.event.repository.name }}
          ls -l
        shell: bash

      # Check tar.gz package built in previous step.
      - name: Run R CMD check üèÅ
        if: contains(env.ENABLED_STEPS, 'run_r_cmd_check')
        run: |
          R CMD check ${{ env.PKGBUILD }}
        shell: bash
        env:
          _R_CHECK_TESTS_NLINES_: 0
          _R_CHECK_VIGNETTES_NLINES_: 0

      # Upload tar.gz package as an artifact so it can be downloaded.
      - name: Upload package build ‚§¥
        if: contains(env.ENABLED_STEPS, 'upload_artifact')
        uses: actions/upload-artifact@v4
        with:
          path: ${{ env.PKGBUILD }}
          name: ${{ env.PKGBUILD }}

  call-reusable-workflow:
    name: Reusable workflow ‚ôªÔ∏è
    uses: user-workshop-cicd/r.pkg.template/.github/workflows/sample-reusable-workflow.yaml@sample-reusable-workflow
    with:
      name: Octocat
